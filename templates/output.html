{% extends "base.html" %}
{% block title %}Prediction Result — Garments Productivity{% endblock %}

{% block content %}
<style>
/* Local styles for output page */
.output-grid { display:grid; grid-template-columns: 320px 1fr; gap:20px; align-items:start; }
@media (max-width:920px){ .output-grid{grid-template-columns:1fr} }

.gauge-card {
  padding:18px;border-radius:12px;background:var(--glass);border:1px solid rgba(255,255,255,0.02);
  display:flex;flex-direction:column;align-items:center;gap:14px;
}
.gauge { width:160px;height:160px;display:grid;place-items:center;position:relative; }
.gauge svg{width:100%;height:100%;transform:rotate(-90deg);}
.gauge .value{ position:absolute;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:700;color:var(--text); }
.gauge .value small{font-weight:600;color:var(--muted);font-size:12px;margin-top:4px}

/* horizontal score bar */
.score-bar { height:14px;border-radius:999px;background:rgba(255,255,255,0.03);overflow:hidden;border:1px solid rgba(255,255,255,0.02) }
.score-fill { height:100%; width:0%; border-radius:999px; transition:width 700ms ease; }

/* interpretation & cards */
.summary-card {
  padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  border:1px solid rgba(255,255,255,0.02);
}
.badge { display:inline-block;padding:8px 14px;border-radius:999px;font-weight:700;font-size:14px }
.badge-low{background:linear-gradient(90deg,#ff7a7a,#ffb3b3);color:#2b0b0b}
.badge-medium{background:linear-gradient(90deg,#ffd166,#ffd8a8);color:#2b1600}
.badge-high{background:linear-gradient(90deg,#7ee3d6,#06b6d4);color:#032226}

/* quick recommended actions */
.actions { display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
.action-ghost { background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--text);text-decoration:none }
.action-primary { padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;text-decoration:none;font-weight:700 }

/* subtle animation */
.fade-in { animation: fadeUp .4s ease both; }
@keyframes fadeUp { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }
</style>

<h2>Prediction Result</h2>
<p class="lead">Below is the model output based on submitted inputs.</p>

{# --- robust defaults --- #}
{% set score = prediction_score|default(None) %}
{% set notes = prediction_notes|default('') %}
{# ensure numeric s variable exists if score provided, else None #}
{% if score is not none %}
  {% set s = (score|float) %}
{% else %}
  {% set s = None %}
{% endif %}

{# categorize safely using s (which may be None) #}
{% if s is not none %}
  {% if s < 0.4 %}
    {% set label = "Low" %}
    {% set badge_class = "badge-low" %}
    {% set interpretation = "Low productivity — investigate downtime and process disruptions." %}
    {% set suggestions = ["Check idle time and idle men","Reduce style changes","Review incentives & SMV"] %}
  {% elif s < 0.75 %}
    {% set label = "Medium" %}
    {% set badge_class = "badge-medium" %}
    {% set interpretation = "Medium productivity — stable but opportunities to improve." %}
    {% set suggestions = ["Optimize worker allocation","Reduce small stoppages","Monitor SMV across styles"] %}
  {% else %}
    {% set label = "High" %}
    {% set badge_class = "badge-high" %}
    {% set interpretation = "High productivity — keep current practices; monitor for burnout." %}
    {% set suggestions = ["Maintain incentives","Document best practices","Scale what works"] %}
  {% endif %}
  {% set pct = (s * 100) | round(1) %}
{% else %}
  {% set label = "Unknown" %}
  {% set badge_class = "badge-medium" %}
  {% set interpretation = "No prediction available." %}
  {% set suggestions = [] %}
  {% set pct = 0 %}
{% endif %}

{# final fallbacks just in case #}
{% set pct = pct|default(0, true) %}
{% set label = label|default('Unknown') %}
{% set badge_class = badge_class|default('badge-medium') %}
{% set interpretation = interpretation|default('No prediction available.') %}
{% set suggestions = suggestions|default([]) %}
{% set display_score = score if score is not none else None %}

<div class="output-grid fade-in" role="region" aria-label="prediction-output">
  <!-- left: gauge & snapshot -->
  <div class="gauge-card" aria-hidden="false">
    <div class="gauge" role="img" aria-label="productivity gauge">
      <!-- SVG circular gauge -->
      <svg viewBox="0 0 36 36" aria-hidden="true">
        <path class="bg"
              d="M18 2.0845
                 a 15.9155 15.9155 0 0 1 0 31.831
                 a 15.9155 15.9155 0 0 1 0 -31.831"
              fill="none" stroke="rgba(255,255,255,0.04)" stroke-width="2.8"/>
        <path class="progress"
              d="M18 2.0845
                 a 15.9155 15.9155 0 0 1 0 31.831
                 a 15.9155 15.9155 0 0 1 0 -31.831"
              fill="none" stroke-width="2.8"
              stroke-linecap="round"
              stroke="url(#grad1)"
              stroke-dasharray="{{ pct }}, 100" />
        <defs>
          <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#ffd166"/>
            <stop offset="50%" stop-color="#f59e0b"/>
            <stop offset="100%" stop-color="#06b6d4"/>
          </linearGradient>
        </defs>
      </svg>

      <div class="value">
        {% if display_score is not none %}
          <div style="font-size:22px">{{ '%.3f' | format(display_score|float) }}</div>
          <small>Productivity score</small>
        {% else %}
          <div style="font-size:18px">—</div>
          <small>No score</small>
        {% endif %}
      </div>
    </div>

    <div style="width:100%">
      <div style="display:flex;align-items:center;gap:12px;justify-content:center">
        <span class="badge {{ badge_class }}">{{ label }}</span>
      </div>

      <div style="margin-top:12px">
        <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Position in range</div>
        <div class="score-bar" aria-hidden="true">
          <!-- safe: use default 0 when pct missing -->
          <div id="score-fill" class="score-fill"
               style="width: {{ pct|default(0, true) }}%; background: linear-gradient(90deg, #ffd166, #06b6d4)"></div>
        </div>
        <div style="margin-top:8px;font-size:13px;color:var(--muted);text-align:center">{{ pct|default(0, true) }}% (0 - 100)</div>
      </div>
    </div>

    <div style="width:100%;margin-top:10px;text-align:center" class="actions">
      <a href="{{ url_for('predict') }}" class="action-ghost">Run another</a>
      {% if result_id is defined and result_id %}
        <a href="{{ url_for('download_result', id=result_id) }}" class="action-primary">Download CSV</a>
      {% endif %}
    </div>
  </div>

  <!-- right: detailed interpretation -->
  <div>
    <div class="summary-card">
      <h3 style="margin-top:0">Summary</h3>
      <p class="info" style="margin:6px 0 12px">Model confidence and additional details are shown here.</p>

      <dl style="margin:6px 0 0;color:var(--muted)">
        <dt style="font-weight:700;color:var(--text)">Predicted Productivity Score</dt>
        <dd style="margin:6px 0 12px;font-size:20px;font-weight:700">
          {% if display_score is not none %}{{ '%.3f' | format(display_score|float) }}{% else %}—{% endif %}
        </dd>

        <dt style="font-weight:700;color:var(--text)">Category</dt>
        <dd style="margin:6px 0 12px;font-size:16px;">
          <span class="badge {{ badge_class }}">{{ label }}</span>
        </dd>

        <dt style="font-weight:700;color:var(--text)">What this means</dt>
        <dd style="margin:6px 0 12px;color:var(--muted)">{{ interpretation }}</dd>

        <dt style="font-weight:700;color:var(--text)">Notes</dt>
        <dd style="margin:6px 0 12px;color:var(--muted)">{% if notes %}{{ notes }}{% else %}No extra notes provided.{% endif %}</dd>
      </dl>

      <hr style="border-color: rgba(255,255,255,0.03);margin:12px 0">

      <h4 style="margin:6px 0 8px">Recommended next steps</h4>
      <ul style="color:var(--muted);margin:0 0 12px;padding-left:18px">
        {% for act in suggestions %}
          <li>{{ act }}</li>
        {% else %}
          <li>No recommendations available.</li>
        {% endfor %}
      </ul>

      {% if s is not none %}
      <div style="margin-top:8px">
        <strong>Quick tweak experiments</strong>
        <p style="color:var(--muted);margin:6px 0 0">Try small changes — e.g., reduce idle time by 10% and re-run the prediction to check impact.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// small animation: animate score-fill from 0 -> pct
(function(){
  const fill = document.getElementById('score-fill');
  if(fill){
    const target = fill.style.width;
    fill.style.width = '0%';
    setTimeout(()=> fill.style.width = target, 50);
  }
})();
</script>

{% endblock %}
